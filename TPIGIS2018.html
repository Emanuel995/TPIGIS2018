<!doctype html>
<html lang="en">
    <head>
        <!-- archivo CSS con los estilos propios de OpenLayers (href con ruta relativa) -->
        <link rel="stylesheet" href="ol4/css/ol.css" type="text/css">

        <style>
            /* selector CSS #map: selecciona cualquier elemento con id="map" */
            #map {
                height: 400px;	/* alto del elemento = 400px */
                width: 100%;	/* ancho del elemento = 100% de su elemento contenedor */
                border: 1px solid; /* borde 1px */
            }
        </style>
        <!-- Titulo de la paginan -->
        <title>Trabajo Practico Integrador GIS 2018</title>
        <!-- tag script que incluye el archivo .js que contiene la libreria -->
        <script src="ol4/build/ol.js" type="text/javascript"></script>
        <!-- script con la url del servicio WMS-->
        <script src="url.js" type="text/javascript"></script>
        <!-- script la libreria JQuery-->
        <script src="jquery.min.js" type="text/javascript"></script>
        
    </head>

    <body>
        <!--Imagen Soy el MAPA y TITULO-->
        <h1><img src="imagenes/soyelmapa.jpeg" width="75" height="75">
            Trabajo Practico Integrador GIS 2018 </h1>
        
        <!-- DIV que contiene el mapa -->
        <div id="map"></div>
        <div id="panel">
                <h3><img src="imagenes/capas.jpg" width="75" height="75">Capas</h3>
                <input type="checkbox" id="check_layer_1"><label for="check_layer_1"> Espejos de Agua</label><br/>
                <input type="checkbox" id="check_layer_2"><label for="check_layer_2"> Red Vial</label><br/>
                <input type="checkbox" id="check_layer_3"><label for="check_layer_3"> Vegetacion Cultivos</label><br/>
                <input type="checkbox" id="check_layer_4"><label for="check_layer_4"> Vegetacion Arborea</label><br/>
                <input type="checkbox" id="check_layer_5"><label for="check_layer_5"> Vegetacion Hidrofila</label><br/>
                
                <!-- Radio buttons para cambiar las interacciones activas -->
                <h3><img src="imagenes/controles.jpg" width="75" height="75">
                    Controles</h3>
                <!-- evento onchange: ejecuta la funcion seleccionarControl -->
                <input
                    type="radio"
                    name="controles"
                    id="controles_navegacion"
                    value="navegacion"
                    checked="checked"
                    onchange="seleccionarControl(this)"

                > <label for="controles_navegacion"> Navegacion</label><br/>
            <input
                type="radio"
                name="controles"
                id="controles_consulta"
                value="consulta"
                onchange="seleccionarControl(this)"
                > <label for="controles_consulta"> Consulta</label><br/>

            </div>

        <!-- SCRIPT que crea el mapa y sus capas -->
        <script type="text/javascript">
            // defino las variables de las capas para usarlas luego
            var espejo_de_agua= new ol.layer.Image({//objeto capa de tipo Imagen (1 sola imagen)
                    title: "espejo_de_agua_hid",
                    visible: false,
                    source: new ol.source.ImageWMS({//fuente de datos (ImageWMS)
                        url: URL_OGC,
                        params: {LAYERS: 'espejo_de_agua_hid'}//por defecto version WMS = 1.3.0
                        })
                    })
            var red_vial= new ol.layer.Image({//objeto capa de tipo Imagen (1 sola imagen)
                title: "red_vial",
                visible: false,
                source: new ol.source.ImageWMS({//fuente de datos (ImageWMS)
                    url: URL_OGC,
                    params: {LAYERS: 'red_vial'}//por defecto version WMS = 1.3.0
                        })
                    })
            
            var veg_cultivos= new ol.layer.Image({//objeto capa de tipo Imagen (1 sola imagen)
                title: "veg_cultivos",
                visible: false,
                source: new ol.source.ImageWMS({//fuente de datos (ImageWMS)
                    url: URL_OGC,
                    params: {LAYERS: 'veg_cultivos'}//por defecto version WMS = 1.3.0
                        })
                    })     
                    
            var veg_arborea= new ol.layer.Image({//objeto capa de tipo Imagen (1 sola imagen)
                title: "veg_arborea",
                visible: false,
                source: new ol.source.ImageWMS({//fuente de datos (ImageWMS)
                    url: URL_OGC,
                    params: {LAYERS: 'veg_arborea'}//por defecto version WMS = 1.3.0
                        })
                    })  
            var veg_hidrofila= new ol.layer.Image({//objeto capa de tipo Imagen (1 sola imagen)
                title: "veg_hidrofila",
                visible: false,
                source: new ol.source.ImageWMS({//fuente de datos (ImageWMS)
                    url: URL_OGC,
                    params: {LAYERS: 'veg_hidrofila'}//por defecto version WMS = 1.3.0
                        })
                    })              
            // definicion del mapa y su capa
            var map = new ol.Map({
                target: 'map',                
                layers: [
                    new ol.layer.Tile({
                        title: "Natural Earth Base Map",
                        source: new ol.source.TileWMS({
                            url: 'http://demo.boundlessgeo.com/geoserver/wms',
                            params: {//parametros del servicio WMS
                                LAYERS: 'ne:ne', //capa(s) del servicio WMS
                                VERSION: '1.1.1' //version del estandar WMS
                            }
                        })
                    }),
                    //Agregamos las demas capas 
                    //Capa 1
                    espejo_de_agua,
                    red_vial,
                    veg_arborea,
                    veg_cultivos,
                    veg_hidrofila
                    //Fin Capa 1
                    

                    //Fin de las capas
                ],
                view: new ol.View({
                    projection: 'EPSG:4326',
                    center: [-59, -27.5],
                    zoom: 6
                 })
             });
            
             //function que va a realizar la peticion de la consulta
            var consultar = function(coordinate){
                console.log(coordinate);
                if(coordinate.length==2){
                    //es un punto [lon,lat]
                    var wkt='POINT('+coordinate[0]+' ' +coordinate[1]+')';
                }else{
                    //es un poligono en la forma [ [ [lon,lat],[lon,lat],....] ]
                    var wkt = 'POLYGON((';
                    for(var i=0;i<coordinate[0].length - 1;i++){
                        wkt+=coordinate[0][i][0]+ ' ' + coordinate[0][i][1]+ ',';
                    }
                    wkt+=coordinate[0][0][0]+' '+coordinate[0][0][1]+'))'
                }
                console.log(wkt);
                window.open('consulta.php?wkt='+wkt);return;
                    // jQuery.ajax({
                    //     url:'consulta.php',
                    //     method: 'GET',
                    //     data:{
                    //         wkt:wkt
                    //     },
                    //     success:function(data){
                    //         console.log(data);
                    //     }
                    // });
            };
            //Interaccion para crear un dragbox
            var selectInteraction = new ol.interaction.DragBox(
                    {
                    //condicion mediante la cual se activa la interaccion
                    condition: ol.events.condition.always, 
                    //estilo del rectangulo a dibujar (el dragbox)
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: [255, 0, 0, 1]
                        })
                    })
                    }
            );
            selectInteraction.on('boxend', function (evt) {
                //mando por consola las coordenadas de la geometria creada
                console.log('boxend', selectInteraction.getGeometry().getCoordinates());
                //consulta en funcion de las coordenadas del dragbox
                consultar(selectInteraction.getGeometry().getCoordinates());
            });
            //funcion para el evento click en el mapa
            var clickEnMapa = function (evt) {
                //muestro por consola las coordenadas del evento
                console.log('click',evt.coordinate);
                //consulta en funcion de un punto
                consultar(evt.coordinate);
            };
            //function para "cambiar" de interaction en function del value de los radios
            var seleccionarControl = function (el) {
                if (el.value == "consulta") {
                    //agrego la interaccion del dragbox
                    //la cual tiene precedencia sobre las otras
                    map.addInteraction(selectInteraction);
                    //subscribo una funcion al evento click del mapa
                    map.on('click', clickEnMapa);
                } else if (el.value == "navegacion") {
                    //la remuevo...
                    map.removeInteraction(selectInteraction);
                    map.un('click', clickEnMapa);
                }
                //muestro por consola el valor
                console.log(el.value);
            };


            //visibilidad de las capas
            //obtengo una referencia al elemento HTML
            var checkbox1 = document.getElementById('check_layer_1');
            //agrego un listener al evento change del checkbox
            checkbox1.addEventListener('change', function () {
                var checked = this.checked;
                //seteo la propiedad "visible" de mi capa en función al valor
                if (checked !== espejo_de_agua.getVisible()) {
                    espejo_de_agua.setVisible(checked);
                }
            });
            //agrego un listener al evento change de la
            //propiedad "visible" de la capa
            espejo_de_agua.on('change:visible', function () {
                var visible = this.getVisible();
                //seteo el valor del checkbox
                if (visible !== checkbox1.checked) {
                    checkbox1.checked = visible;
                }
            });

            var checkbox2 = document.getElementById('check_layer_2');
            checkbox2.addEventListener('change', function () {
                var checked = this.checked;
                if (checked !== red_vial.getVisible()) {
                    red_vial.setVisible(checked);
                }
            });
            red_vial.on('change:visible', function () {
                var visible = this.getVisible();
                if (visible !== checkbox2.checked) {
                    checkbox2.checked = visible;
                }
            });
            
            var checkbox3 = document.getElementById('check_layer_3');
            checkbox3.addEventListener('change', function () {
                var checked = this.checked;
                if (checked !== veg_arborea.getVisible()) {
                    veg_arborea.setVisible(checked);
                }
            });
            veg_arborea.on('change:visible', function () {
                var visible = this.getVisible();
                if (visible !== checkbox3.checked) {
                    checkbox3.checked = visible;
                }
            });

            var checkbox4 = document.getElementById('check_layer_4');
            checkbox4.addEventListener('change', function () {
                var checked = this.checked;
                if (checked !== veg_cultivos.getVisible()) {
                    veg_cultivos.setVisible(checked);
                }
            });
            veg_cultivos.on('change:visible', function () {
                var visible = this.getVisible();
                if (visible !== checkbox4.checked) {
                    checkbox4.checked = visible;
                }
            });

             var checkbox5 = document.getElementById('check_layer_5');
            checkbox5.addEventListener('change', function () {
                var checked = this.checked;
                if (checked !== veg_hidrofila.getVisible()) {
                    veg_hidrofila.setVisible(checked);
                }
            });
            veg_hidrofila.on('change:visible', function () {
                var visible = this.getVisible();
                if (visible !== checkbox5.checked) {
                    checkbox5.checked = visible;
                }
            });
            
         </script>
     </body>
 </html>